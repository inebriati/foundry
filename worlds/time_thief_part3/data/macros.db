{"_id":"SbL6yWTSn3OIUHU3","name":"Chaotic Attack","permission":{"default":0,"TvnKUSN54wWwH5vI":3},"type":"script","sort":100001,"flags":{},"scope":"global","command":"/** Globals **/\r\n//let attack_roll = `1d20 + @prof + @abilities.str.mod`;\r\nlet attack_roll = `1d20 + 10`;\r\nlet damage_roll = `2d8 + 5`;\r\nlet crit_range = 19;\r\n\r\n/** Functions **/\r\n\r\nRoll.prototype.chat = function(msg) {\r\n  this.toMessage({\r\n    flavor: msg,\r\n    speaker: ChatMessage.getSpeaker({token: token}),\r\n  });\r\n};\r\n\r\nRoll.prototype.roll_with_crit = function(crit) {\r\n  if (crit) {\r\n    let new_roll = [];\r\n    this.formula.split(\" \").forEach(function (v) {\r\n      if (v.match(/\\d+d\\d+/g)) {\r\n        new_roll.push(v);\r\n        new_roll.push(\"+\");\r\n      }\r\n      new_roll.push(v);\r\n    });\r\n    this.formula = new_roll.join(\" \");\r\n  }\r\n  return this.roll();\r\n};\r\n\r\nArray.prototype.sample = function() {\r\n  return this[Math.floor(Math.random()*this.length)];\r\n};\r\n\r\n/** Validation **/\r\nif (!token) {\r\n  ui.notifications.error(\"No token was selected!\");\r\n}\r\n\r\nelse {\r\n\r\n/** Code **/\r\n\r\n  // randomly decide if this is an attack or save roll\r\n  let type = [\"attack\", \"save\"].sample();\r\n\r\n  // randomly decide the damage type\r\n  let damage_type = [\"acid\", \"bludgeoning\", \"cold\", \"fire\", \"force\", \"lightning\", \"necrotic\", \"piercing\", \"poison\", \"psychic\", \"radiant\", \"slashing\", \"thunder\"].sample();\r\n  let crit = false;\r\n\r\n  // calculate raw attack damage and if we've critted\r\n  if (type == \"attack\") {\r\n    let attack = new Roll(attack_roll, token.actor.getRollData()).roll();\r\n    crit = attack.parts[0].rolls[0][\"roll\"] >= crit_range;\r\n\r\n    if (crit) {\r\n      attack.chat(`${actor.name} fucks you up!`);\r\n    }\r\n    else {\r\n      attack.chat(`${actor.name} attacks!`);\r\n    }\r\n  }\r\n\r\n  // randomly determine the save type and DC\r\n  else {\r\n    let ability = [\"str\", \"dex\", \"int\", \"wis\", \"cha\"].sample();\r\n    let dc = Math.floor(Math.random()*8) + 12;\r\n\r\n    ChatMessage.create({\r\n      content: `${actor.name}'s eyes glow! [DC ${dc} ${ability} save]`,\r\n      speaker: ChatMessage.getSpeaker({token: token}),\r\n    });\r\n  }\r\n\r\n  // roll damage, roll any dice twice if we've critted\r\n  let damage = new Roll(damage_roll, token.actor.getRollData()).roll_with_crit(crit);\r\n  damage.chat(`(${damage_type} damage)`);\r\n}\r\n","author":"TvnKUSN54wWwH5vI","img":"icons/svg/dice-target.svg","actorIds":[]}
